{% extends "base.html" %}
{% block title %}üî• Hot Shorts{% endblock %}

{% block content %}
<style>
    body {
        background-color: #111;
        color: #fff;
        font-family: 'Segoe UI', sans-serif;
    }
    .top-bar {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 10px;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        background-color: rgba(17, 17, 17, 0.8);
        backdrop-filter: blur(5px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }
    .back-btn {
        background-color: #ff0055;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 0 10px #ff0055;
        text-decoration: none;
        transition: transform 0.2s ease;
    }
    .back-btn:hover {
        transform: scale(1.1);
    }
    .upload-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #ff0055;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        width: 60px;
        height: 60px;
        cursor: pointer;
        box-shadow: 0 0 10px #ff0055;
        z-index: 999;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .modal-content {
        background-color: #222;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #555;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        color: #fff;
        box-shadow: 0 0 10px #ff0055;
    }
    .modal-content input, .modal-content button {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        border-radius: 6px;
        border: none;
    }
    .reel-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 60px; /* Espacio para el bot√≥n de regreso */
        gap: 30px;
        padding-bottom: 80px; /* Espacio para el bot√≥n de subir */
    }
    .reel {
        background-color: #1a1a1a;
        padding: 15px;
        border-radius: 10px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 0 10px #444;
    }
    video {
        width: 100%;
        border-radius: 8px;
    }
    .reacciones-panel {
        display: flex;
        justify-content: space-around;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .reacciones-panel button {
        background-color: transparent;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
    }
    .btn-comentar {
        background-color: #ff2d75;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin-left: 6px;
    }
    /* Estilos para el overlay de carga */
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1001;
        display: none;
        justify-content: center;
        align-items: center;
    }
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #ff0055;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 2s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="top-bar">
    <a href="{{ url_for('inicio') }}" class="back-btn">
        <span aria-hidden="true">‚Üê</span>
    </a>
</div>

<div id="loadingOverlay">
    <div class="loader"></div>
</div>

<button class="upload-btn" onclick="document.getElementById('uploadModal').style.display='block'">Ôºã</button>

<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h2>üìπ Subir un HotShort</h2>
        <form id="uploadForm" method="POST" enctype="multipart/form-data">
            <input type="text" name="titulo" placeholder="T√≠tulo del video" required>
            <input type="file" name="archivo" accept="video/*" required>
            <button type="submit" style="background-color:#ff0055;color:#fff;">Subir</button>
        </form>
        <button onclick="document.getElementById('uploadModal').style.display='none'" style="background:#555;color:white;">Cancelar</button>
    </div>
</div>

<div class="reel-container" id="reelContainer">
    {% if reels %}
        {% for reel in reels %}
        <div class="reel" id="reel-{{ reel._id }}">
            <video controls playsinline loop src="{{ url_for('stream_video', file_id=reel.archivo_id) }}"></video>
            <div class="reacciones-panel">
                <button onclick="likeReel('{{ reel._id }}', this)">‚ù§ {{ reel.likes }}</button>
                <button onclick="fireReel('{{ reel._id }}', this)">üî• {{ reel.fuegos }}</button>
                <button onclick="regalarReel('{{ reel._id }}', this)">üí∞ {{ reel.tokens_recibidos }}</button>
                {% if reel.usuario == session.get('alias') or session.get('rol') == 'admin' %}
                <button onclick="deleteReel('{{ reel._id }}')">üóëÔ∏è Eliminar</button>
                {% endif %}
            </div>
            <div>
                <div id="comentarios-{{ reel._id }}">
                    {% for c in reel.get('comentarios', []) %}
                    <p>üí¨ {{ c.texto }}</p>
                    {% endfor %}
                </div>
                <div style="display:flex; margin-top:5px;">
                    <input type="text" id="comentario-{{ reel._id }}" placeholder="Escribe un comentario..." style="flex:1; padding:6px;">
                    <button class="btn-comentar" onclick="comentarReel('{{ reel._id }}')">Enviar</button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p>No hay videos disponibles. ¬°Sube el primero!</p>
    {% endif %}
</div>

<script>
    // Funci√≥n para mostrar el overlay de carga
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // Modificar el env√≠o del formulario para mostrar la carga
    document.getElementById('uploadForm').addEventListener('submit', function(event) {
        showLoading();
    });

    function likeReel(id, btn) {
        fetch(`/reel/${id}/like`, { method: 'POST' }).then(() => {
            let count = parseInt(btn.innerText.match(/\d+/)[0]) + 1;
            btn.innerText = `‚ù§ ${count}`;
        });
    }

    function fireReel(id, btn) {
        fetch(`/reel/${id}/fire`, { method: 'POST' }).then(() => {
            let count = parseInt(btn.innerText.match(/\d+/)[0]) + 1;
            btn.innerText = `üî• ${count}`;
        });
    }

    function regalarReel(reelId, btn) {
        fetch(`/reel/${reelId}/regalar`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                let currentTokens = parseInt(btn.innerText.match(/\d+/)[0]);
                btn.innerText = `üí∞ ${currentTokens + 1}`;
            } else {
                alert(data.message);
            }
        });
    }

    function comentarReel(id) {
        let input = document.getElementById(`comentario-${id}`);
        let texto = input.value.trim();
        if (!texto) return;
        fetch(`/reel/${id}/comentar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ texto })
        }).then(() => {
            let comentariosDiv = document.getElementById(`comentarios-${id}`);
            comentariosDiv.innerHTML += `<p>üí¨ ${texto}</p>`;
            input.value = '';
        });
    }

    function deleteReel(id) {
        if (!confirm("¬øEliminar este video?")) return;
        fetch(`/eliminar_shorts/${id}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`reel-${id}`).remove();
                alert(data.message);
            } else {
                alert(data.message);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const videos = document.querySelectorAll("video");
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.play();
                } else {
                    entry.target.pause();
                }
            });
        }, { threshold: 0.6 });
        videos.forEach(v => observer.observe(v));
    });
</script>
{% endblock %}