{% extends "base.html" %}
{% block title %}üî• Hot Shorts{% endblock %}

{% block content %}
<style>
    body {
        background-color: #111;
        color: #fff;
        font-family: 'Segoe UI', sans-serif;
    }
    .upload-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #ff0055;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        width: 60px;
        height: 60px;
        cursor: pointer;
        box-shadow: 0 0 10px #ff0055;
        z-index: 999;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
    }
    .modal-content {
        background-color: #222;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #555;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        color: #fff;
        box-shadow: 0 0 10px #ff0055;
    }
    .modal-content input, .modal-content button {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        border-radius: 6px;
        border: none;
    }
    .reel-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
        gap: 30px;
    }
    .reel {
        background-color: #1a1a1a;
        padding: 15px;
        border-radius: 10px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 0 10px #444;
    }
    video {
        width: 100%;
        border-radius: 8px;
    }
    .reacciones-panel {
        display: flex;
        justify-content: space-around;
        margin-top: 10px;
    }
    .reacciones-panel button {
        background-color: transparent;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
    }
    .btn-regalar {
        background: gold;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
    }
</style>

<button class="upload-btn" onclick="document.getElementById('uploadModal').style.display='block'">Ôºã</button>

<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h2>üìπ Subir un HotShort</h2>
        <form method="POST" enctype="multipart/form-data">
            <input type="text" name="titulo" placeholder="T√≠tulo del video" required>
            <input type="file" name="archivo" accept="video/*" required>
            <button type="submit" style="background-color:#ff0055;color:#fff;">Subir</button>
        </form>
        <button onclick="document.getElementById('uploadModal').style.display='none'" style="background:#555;color:white;">Cancelar</button>
    </div>
</div>

<div class="reel-container" id="reelContainer">
    {% for reel in reels %}
    <div class="reel">
        <video muted playsinline loop autoplay src="{{ url_for('stream_video', file_id=reel.archivo_id) }}"></video>
        <div class="reacciones-panel">
            <button onclick="likeReel('{{ reel._id }}', this)">‚ù§ {{ reel.likes }}</button>
            <button onclick="fireReel('{{ reel._id }}', this)">üî• {{ reel.fuegos }}</button>
            <button onclick="regalarReel('{{ reel._id }}', this)">üí∞ {{ reel.tokens_recibidos }}</button>
        </div>
        <div>
            <div id="comentarios-{{ reel._id }}">
                {% for c in reel.get('comentarios', []) %}
                <p>üí¨ {{ c.texto }}</p>
                {% endfor %}
            </div>
            <input type="text" id="comentario-{{ reel._id }}" placeholder="Escribe un comentario..." onkeypress="if(event.key==='Enter'){comentarReel('{{ reel._id }}')}">
        </div>
    </div>
    {% endfor %}
</div>

<script>
// --- Funciones de interacci√≥n ---
function likeReel(id, btn) {
    fetch(`/reel/${id}/like`, { method: 'POST' }).then(() => {
        let count = parseInt(btn.innerText.match(/\d+/)[0]) + 1;
        btn.innerText = `‚ù§ ${count}`;
    });
}

function fireReel(id, btn) {
    fetch(`/reel/${id}/fire`, { method: 'POST' }).then(() => {
        let count = parseInt(btn.innerText.match(/\d+/)[0]) + 1;
        btn.innerText = `üî• ${count}`;
    });
}

function regalarReel(reelId, btn) {
    fetch(`/reel/${reelId}/regalar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let currentTokens = parseInt(btn.innerText.match(/\d+/)[0]);
            btn.innerText = `üí∞ ${currentTokens + 1}`;
            alert(data.message);
        } else {
            alert(data.message || "Ocurri√≥ un error al regalar el token.");
        }
    })
    .catch(error => {
        console.error("Error al enviar token:", error);
        alert("Error al regalar el token.");
    });
}

function comentarReel(id) {
    let input = document.getElementById(`comentario-${id}`);
    let texto = input.value.trim();
    if (!texto) return;
    fetch(`/reel/${id}/comentar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ texto })
    }).then(() => {
        let comentariosDiv = document.getElementById(`comentarios-${id}`);
        comentariosDiv.innerHTML += `<p>üí¨ ${texto}</p>`;
        input.value = '';
    });
}

// --- Autoplay con pausa al salir de la pantalla ---
function observeVideos() {
    const videos = document.querySelectorAll("video");
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.play().catch(()=>{});
            } else {
                entry.target.pause();
            }
        });
    }, { threshold: 0.6 });
    videos.forEach(video => observer.observe(video));
}

// --- Scroll infinito ---
let skipCount = {{ reels|length }};
const limit = 5;
let loadingMore = false;

function createReelHTML(reel) {
    return `
    <div class="reel">
        <video muted playsinline loop autoplay src="{{ url_for('stream_video', file_id=reel.archivo_id) }}"></video>
        <div class="reacciones-panel">
            <button onclick="likeReel('${reel._id}', this)">‚ù§ ${reel.likes}</button>
            <button onclick="fireReel('${reel._id}', this)">üî• ${reel.fuegos}</button>
            <button onclick="regalarReel('${reel._id}', this)">üí∞ ${reel.tokens_recibidos}</button>
        </div>
        <div>
            <div id="comentarios-${reel._id}">
                ${(reel.comentarios || []).map(c => `<p>üí¨ ${c.texto}</p>`).join('')}
            </div>
            <input type="text" id="comentario-${reel._id}" placeholder="Escribe un comentario..." onkeypress="if(event.key==='Enter'){comentarReel('${reel._id}')}">
        </div>
    </div>`;
}

function loadMoreReels() {
    if (loadingMore) return;
    loadingMore = true;
    fetch(`/hot_shorts/load_more?skip=${skipCount}&limit=${limit}`)
        .then(res => res.json())
        .then(data => {
            if (data.length > 0) {
                data.forEach(reel => {
                    document.getElementById('reelContainer').insertAdjacentHTML('beforeend', createReelHTML(reel));
                });
                skipCount += data.length;
                observeVideos();
                loadingMore = false;
            }
        });
}

window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
        loadMoreReels();
    }
});

// Activar al cargar
document.addEventListener("DOMContentLoaded", observeVideos);
</script>
{% endblock %}